"Test python ingest script with string manipulation":
  - do:
      ingest.put_pipeline:
        id: "python-test-pipeline"
        body: >
          {
            "description": "Test python ingest script",
            "processors": [
              {
                "script": {
                  "description": "Extract 'tags' from 'env' field",
                  "lang": "python",
                  "source": "ctx['tags'] = ctx['env'].split(params['delimiter'])[params['position']]",
                  "params": {
                    "delimiter": "-",
                    "position": 3
                  }
                }
              }
            ]
          }

  - do:
      index:
        index: test-ingest
        id: "1"
        pipeline: "python-test-pipeline"
        body: >
          {
            "env": "us-east-1-prod"
          }

  - do:
      indices.refresh:
        index: test-ingest

  - do:
      get:
        index: test-ingest
        id: "1"

  - match: { _source.tags: "prod" }
  - match: { _source.env: "us-east-1-prod" }

  - do:
      ingest.delete_pipeline:
        id: "python-test-pipeline"
        ignore: 404
